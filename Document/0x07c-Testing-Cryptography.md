## 暗号化のテスト

以下の章ではテクニカルテストケースでの MASVS の暗号化要件について説明します。この章に記載されるテストケースはサーバー側に焦点を当てているため、iOS や Android の特定の実装に依存しません。

適切な暗号鍵管理はモバイルアプリケーションを設計する際の共通の落とし穴です。

### 安全でないもしくは廃止された暗号化アルゴリズムに関するテスト

#### 概要

強力な暗号アルゴリズムを選択するだけでは十分ではありません。誤って構成されるとそのようなアルゴリズムのセキュリティに影響を及ぼすことがよくあります。これまでの多くの強力なアルゴリズムや構成が現在では脆弱であるもしくはベストプラクティスに準拠していないとみなされています。したがって、最新のベストプラクティスを定期的に確認し、それに応じて構成を調整することが重要です。

多くの暗号アルゴリズムおよびプロトコルは重大な弱点があることが示されているか、現代のセキュリティ要件には不十分であるため、使用してはいけません。

#### 静的解析

以下のリストはソースコードの暗号アルゴリズムの使用を検証するためのさまざまなチェックを示しています。

* 暗号アルゴリズムは最新のもので業界標準に準拠している。これには、古いブロック暗号 (DES など)、ストリーム暗号 (RC4 など)、ハッシュ関数 (MD5 など)、(NIST 認定であっても) Dual_EC_DRBG などの不十分な乱数生成器などがあります。これらはすべて非セキュアであるとマークされ、使用すべきではなく、アプリやサーバーのコードベースから削除すべきです。
* 鍵長は業界標準に準拠しており、十分な時間を保護する。ムーアの法則を考慮した鍵長と保護の比較はオンラインで利用可能です <sup>[3]</sup> 。
* 暗号パラメータは妥当な範囲内で十分に定義されている。これには、ハッシュ関数出力と少なくとも同じ長さであるべき暗号ソルト、パスワード導出関数と反復回数の妥当な選択肢 (PBKDF2, scrypt, bcrypt など)、ランダムでユニークな IV、適切なブロック暗号モード (ECV は特定のケースを除いて使用すべきではないなど)、適切な鍵管理 (3DES は3つの独立した鍵を持つべきであるなど) など。

アプリケーション全体で暗号アルゴリズムのインスタンスを特定するためにソースコードを調査して、以下のような既知の脆弱なものを探します。

* DES
* RC2
* RC4
* BLOWFISH
* CRC32
* MD4
* MD5
* SHA1 and others.

推奨されるアルゴリズムの基本的なリストについては「改善方法」セクションを参照ください。

脆弱とみなされる DES アルゴリズムの初期化の例：
```Java
Cipher cipher = Cipher.getInstance("DES");
```

##### ブロック暗号モード
ECB (Electronic Codebook) 暗号モードは基本的に未加工の暗号であるため使用すべきではありません。メッセージは固定サイズのブロックに分割され、各ブロックは個別に暗号化されます <sup>[6]</sup> 。

![Electronic Codebook (ECB mode encryption)](Images/Chapters/0x07c/ECB.png)

この暗号化方式の問題点は平文の常駐プロパティが暗号テキストによく現れる可能性があることです。ブロックと鍵スケジュールは防御すべきものですが、パターンを分析することで隠されていると思っているプロパティを推測することができます。

![Difference of encryption modes](Images/Chapters/0x07c/EncryptionMode.png)

#### 動的解析

-- TODO [Give examples of Dynamic Testing for "Testing for Insecure and/or Deprecated Cryptographic Algorithms"] --

#### 改善方法

暗号化手法が廃止されていないことを定期的に確認します。以前、年単位の計算時間を要すると考えられていた一部の古いアルゴリズムは数日もしくは数時間で破られる可能性があります。これには MD4, MD5, SHA1, DES, および以前は強力であると考えられて他のアルゴリズムが含まれます。現在推奨されているアルゴリズムの例です。<sup>[1] [2]</sup>

* 機密性: AES-256
* 完全性: SHA-256, SHA-384, SHA-512
* デジタル署名: RSA (3072 ビット以上), ECDSA with NIST P-384
* 鍵確立: RSA (3072 ビット以上), DH (3072 ビット以上), ECDH with NIST P-384

#### 参考情報

##### OWASP Mobile Top 10
* M6 - Broken Cryptography

##### OWASP MASVS
- V3.3: "アプリは特定のユースケースに適した暗号化プリミティブを使用している。業界のベストプラクティスに基づくパラメータで構成されている。"
- V3.4: "アプリはセキュリティ上の目的で広く廃止対象と考えられる暗号プロトコルやアルゴリズムを使用していない。"

##### CWE
* CWE-326: Inadequate Encryption Strength
* CWE-327: Use of a Broken or Risky Cryptographic Algorithm

##### その他
- [1] Commercial National Security Algorithm Suite and Quantum Computing FAQ - https://cryptome.org/2016/01/CNSA-Suite-and-Quantum-Computing-FAQ.pdf
- [2] NIST Special Publication 800-57 - http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-57pt1r4.pdf
- [3] Security "Crypto" provider deprecated in Android N -  https://android-developers.googleblog.com/2016/06/security-crypto-provider-deprecated-in.html
- [4] NIST recommendations (2016) - https://www.keylength.com/en/4/
- [5] BSI recommendations (2017) - https://www.keylength.com/en/8/
- [6] Electronic Codebook (ECB) - https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Electronic_Codebook_.28ECB.29

##### ツール
* QARK - https://github.com/linkedin/qark
* Mobile Security Framework - https://github.com/ajinabraham/Mobile-Security-Framework-MobSF



### 暗号のカスタム実装に関するテスト

-- [TODO - needs more review / editing ] --

#### 概要

暗号機能に非標準のカスタムビルドアルゴリズムを使用することは危険です。特定の攻撃者がアルゴリズムを破り、保護されているデータを侵害する可能性があります。暗号化機能の実装には時間がかかり、困難であり、失敗する可能性があります。代わりに既にセキュアであることが証明されている既知のアルゴリズムを使用すべきです。すべての成熟したフレームワークやライブラリはモバイルアプリを実装する際にも使用すべき暗号化機能を提供します。

#### 静的解析

ソースコードに含まれるすべての暗号手法、特に機密データに直接適用されている手法を注意深く調べます。一見標準のようにみえるが改変されたアルゴリズムに細心の注意を払います。エンコーディングは暗号化ではないことを忘れないでください。排他的 OR オペレーションなどのビットシフトオペレータが現れたら深く掘り下げてみる良い兆候かもしれません。

-- [TODO - The below content was merged from the old iOS 'Verifying Cryptographic Key Management' section. This section needs some review and editing] --

静的解析の中では、特定のターゲットアプリが暗号アルゴリズムをどのように使用しているかを理解することが重要です。アプリケーションを3つの主要なカテゴリに分けてみます。

1. アプリケーションは純粋なオンラインアプリケーションです。認証、認可はアプリケーションサーバーとオンラインで行われます。情報はローカルに格納されません。
2. アプリケーションは主にオフラインアプリケーションです。認証、認可は純粋にローカルで行われます。アプリケーション情報はローカルにも格納されます。
3. アプリケーションは最初の2つが混在しています。すなわち、オンライン認証とオフライン認証の両方をサポートし、一部の情報はローカルに格納される可能性があり、オンラインで実行されるアクションの一部またはすべてがオフラインで実行される可能性があります。
   * このようなアプリケーションの良い例として売り手が商品を販売する店頭 POS があります。このアプリはバックエンドと通信して販売された商品、現金額などの情報を更新できるようインターネットに接続する必要があります。但し、このアプリはオフラインモードでも動作する必要があり、インターネットに接続するとすべての情報を同期するというビジネス要件があるかもしれません。これはオンラインとオフラインが混在するアプリタイプです。

下2つのアプリカテゴリで以下のチェックを実行します。

* ソースコード内に鍵/パスワードがハードコードや格納されていないことを確認します。ソースコードで有効になっている「管理者」アカウントやバックドアアカウントには特に注意します。アプリケーションやパスワードハッシュ内に固定ソルトを格納すると問題が発生する可能性があります。
* ソースコード内に難読化された鍵やパスワードがないことを確認します。難読化は動的計装によって簡単にバイパスされますので、原理的にハードコードされた鍵と変わりません。
* アプリケーションが双方向 SSL を使用している(すなわち、サーバー証明書とクライアント証明書の両方が検証されている)場合、以下のことを確認します。
   * クライアント証明書のパスワードがローカルに格納されていないこと。キーチェーンに格納する必要があります。
   * クライアント証明書がすべてのインストールで共有されていないこと(アプリ内でハードコードされているなど)

適切な方法は、ユーザー登録/初回ログイン時にクライアント証明書を生成してそれをキーチェーンに格納することです。

* 鍵/パスワード/ログインがアプリケーションデータに格納されていないことを確認します。これには iTunes バックアップを含めることができ、攻撃領域を拡大することができます。キーチェーンはあらゆる種類の資格情報(パスワード、証明書など)を格納する唯一の場所です。
* キーチェーンエントリに適切な保護クラスがあることを確認します。最も厳密なのは `kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly` で次のように解釈されます。デバイスのパスコードが設定され、デバイスがロックされていない場合にのみエントリが解除されます。そのエントリはバックアップやその他の手段でエクスポートできません。

オフラインアプリケーションでは以下のチェックを実行します。

* アプリがアプリデータに格納されている追加の暗号化コンテナに依存している場合は、暗号鍵の使用方法を確認します。
   * 鍵ラッピングスキームが使用されている場合は、マスターシークレットがユーザーごとに初期化されているか、コンテナが新しい鍵で再暗号化されていることを確認します。
   * マスターシークレットや以前のパスワードを使用してコンテナを復号化できる場合は、パスワード変更がどのように処理されるかを確認します。

#### 動的解析

カスタム暗号化方式が本当に適切かどうか確認するために、APK を逆コンパイルしてアルゴリズムを調べることをお勧めします(「静的解析」を参照ください)。

#### 改善方法

カスタム暗号アルゴリズムを開発してはいけません。これは暗号技術者によりよく知られている攻撃を受ける可能性が高いためです。

機密データを格納する必要がある場合は強力な最新の暗号アルゴリズムを使用します。この分野の専門家により現時点で強力であると見なされている十分に検証されたアルゴリズムを選択し、十分にテストされた実装を使用します。KeyStore は機密情報を格納するのに適しており、Android のドキュメントには提供される強力な暗号のリストがあります <sup>[1]</sup>。

#### 参考情報

##### OWASP Mobile Top 10 2016
* M6 - Broken Cryptography

##### OWASP MASVS
- V3.2: "アプリは実績のある暗号プリミティブの実装を使用している。"

##### CWE
* CWE-327: Use of a Broken or Risky Cryptographic Algorithm

##### その他
[1] Supported Ciphers in KeyStore - https://developer.android.com/training/articles/keystore.html#SupportedCiphers
